<html>
    <head>
        <meta charset="utf-8" name="viewport" content="initial-scale=1, width=device-width"/>
        <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js" crossorigin></script>
        <!-- Production -->
        <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/@mui/material@v5.6.1/umd/material-ui.production.min.js" crossorigin></script>
        <!-- Development
        <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
        <script src="https://unpkg.com/@mui/material@v5.6.1/umd/material-ui.development.js" crossorigin></script>
        ->

        <!-- Can remove this for a pre-processor -->
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
        <!-- Fonts to support Material Design -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
        <!-- Icons to support Material Design -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    </head>

    <body>
        <div id="root"> Loading... </div>
        <script type="text/babel">
            const DEFAULT_MSG = "Enter a GitHub repo and branch to review. Runs entirely in your browser using React, MaterialUI, and Pyodide.";
            function Heading(props) {
                return (
                    <MaterialUI.Box sx={{ flexGrow: 1, mb: 2 }}>
                        <MaterialUI.AppBar position="static">
                            <MaterialUI.Toolbar>
                            <MaterialUI.Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
                                Scikit-HEP-Repo-Review
                            </MaterialUI.Typography>
                            <MaterialUI.Button href="https://scikit-hep.org/developer" color="inherit">Developer Guidelines</MaterialUI.Button>
                            <MaterialUI.Button href="https://github.com/henryiii/scikit-hep-repo-review" color="inherit">Source</MaterialUI.Button>
                            </MaterialUI.Toolbar>
                        </MaterialUI.AppBar>
                    </MaterialUI.Box>
                );
            }

            function Results(props) {
                const output = [];
                for (const key in props.results) {
                    const inner_results = props.results[key];
                    const results_components = inner_results.map(result => {
                        const details = result.state === false ? <span dangerouslySetInnerHTML={{__html: result.err_msg }} />: null;
                        const color = result.state === false ? 'error' : (result.state === true ?  'success' : 'warning');
                        const icon = <MaterialUI.Icon color={color}>{result.state === false ? 'error' : (result.state === true ? 'check_circle' : 'warning' )}</MaterialUI.Icon>;
                        const msg = (
                            <React.Fragment>
                                <MaterialUI.Typography
                                    sx={{ display: 'inline' }}
                                    component="span"
                                    variant="body2"
                                    color="text.primary"
                                >
                                    {result.name + ": "}
                                </MaterialUI.Typography>
                                {result.description}
                            </React.Fragment>
                        )
                        return (
                            <MaterialUI.ListItem disablePadding key={result.name}>
                                <MaterialUI.ListItemButton>
                                    <MaterialUI.ListItemIcon>
                                        {icon}
                                    </MaterialUI.ListItemIcon>
                                    <MaterialUI.ListItemText primary={msg} secondary={details} color={color} />
                                </MaterialUI.ListItemButton>
                            </MaterialUI.ListItem>
                        );
                    });

                    output.push(
                        <li key={`section-${key}`}>
                            <ul>
                                <MaterialUI.ListSubheader>{key}</MaterialUI.ListSubheader>
                                {results_components}
                            </ul>
                        </li>
                        );
                }

                return (
                    <MaterialUI.Box sx={{bgcolor: 'background.paper'}} >
                        <MaterialUI.List subheader={<li />} overflow='auto'>{output}</MaterialUI.List>
                    </MaterialUI.Box>
                );
            }

            async function prepare_pyodide() {
                const pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.20.0/full/"
                });

                await pyodide.loadPackage('micropip');
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install(["scikit_hep_repo_review==0.2.1", "markdown-it-py"])
                `);
                return pyodide;
            }

            const pyodide_promise = prepare_pyodide();

            class App extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {
                        results: [],
                        repo: "",
                        branch: "",
                        msg: DEFAULT_MSG,
                    };
                }

                hadleComputeCallback(pyodide, state) {
                    pyodide.runPython(`
                        from pyodide.http import open_url
                        import js
                        val = open_url(f"{js.location.pathname}ghpath.py")
                        with open("ghpath.py", "w") as f:
                            f.write(val.read())
                    `);
                    const results_dict = pyodide.runPython(`
                        from scikit_hep_repo_review.processor import process
                        from ghpath import GHPath
                        from markdown_it import MarkdownIt
                        md = MarkdownIt()
                        package = GHPath(repo="${state.repo}", branch="${state.branch}")
                        results_dict = process(package)
                        for cat_group in results_dict.values():
                            for result in cat_group:
                                object.__setattr__(result, "err_msg", md.render(result.err_msg))
                        results_dict
                    `);

                    const results = {};
                    for(const res of results_dict) {
                        const vals = results_dict.get(res);
                        const inner_results = []
                        for(const val of vals) {
                            inner_results.push({
                                name: val.name.toString(),
                                description: val.description.toString(),
                                state: val.result,
                                err_msg: val.err_msg.toString()
                            })
                        }
                        results[res] = inner_results;
                    }

                    this.setState({results: results, msg: `Results for ${state.repo}@${state.branch}`});

                }

                handleCompute() {
                    if (!this.state.repo || !this.state.branch ) {
                        this.setState({"results": [], msg: DEFAULT_MSG});
                        alert(`Please enter a repo (${this.state.repo}) and branch (${this.state.branch})`);
                        return;
                    }
                    this.setState({"results": [], msg: "Loading..."});
                    pyodide_promise.then(pyodide => {
                        this.hadleComputeCallback(pyodide, this.state);
                    });
                }

                helpbox() {
                    return (
                        <MaterialUI.Box sx={{ p: 2 }}>
                            <MaterialUI.Typography variant="body1" component="div">
                                {this.state.msg}
                            </MaterialUI.Typography>
                        </MaterialUI.Box>
                    );
                }


                render() {
                    const common_branches = ["main", "master", "develop", "stable"];
                    return (
                        <MaterialUI.Box>
                        <Heading />
                        <MaterialUI.Stack direction="row" spacing={2} justifyContent="center" alignItems="top" sx={{ m: 1, mb: 3 }}>
                            <MaterialUI.TextField
                                id="repo-select"
                                label="Org/Repo"
                                helperText="e.g. scikit-hep/hist"
                                variant="outlined"
                                autoFocus={true}
                                onInput={(e) => this.setState({repo: e.target.value})}
                            />
                            <MaterialUI.Autocomplete
                                disablePortal
                                id="branch-select"
                                options={common_branches}
                                freeSolo = {true}
                                renderInput={(params) => <MaterialUI.TextField {...params} label="Branch" variant="outlined" helperText="e.g. main" />}
                                onInputChange={(e, value) => this.setState({branch: value})}
                            />
                            <MaterialUI.Button onClick={() => this.handleCompute()} variant="contained" size="large">Compute!</MaterialUI.Button>
                        </MaterialUI.Stack>
                        <MaterialUI.Paper elevation={3}>
                            {this.helpbox()}
                            <Results results={this.state.results} />
                        </MaterialUI.Paper>
                        </MaterialUI.Box>
                    );
                }
            }

            function main() {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            }

            main();

        </script>
    </body>
</html>
